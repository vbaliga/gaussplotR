<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Troubleshooting model fits • gaussplotR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Troubleshooting model fits">
<meta property="og:description" content="gaussplotR">
<meta property="og:image" content="https://vbaliga.github.io/gaussplotR/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">gaussplotR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/fit_gaussian_2D.html">Fitting 2D Gaussians to data</a>
    </li>
    <li>
      <a href="../articles/formulas-used-by-fit-gaussian-2D.html">Formulas used by fit_gaussian_2D</a>
    </li>
    <li>
      <a href="../articles/troubleshooting-model-fits.html">Troubleshooting model fits</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/vbaliga/gaussplotR/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Troubleshooting model fits</h1>
                        <h4 class="author">Vikram B. Baliga</h4>
            
            <h4 class="date">2021-02-12</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/vbaliga/gaussplotR/blob/master/vignettes/troubleshooting-model-fits.Rmd"><code>vignettes/troubleshooting-model-fits.Rmd</code></a></small>
      <div class="hidden name"><code>troubleshooting-model-fits.Rmd</code></div>

    </div>

    
    
<p>Automatically finding good initial values for parameters in a nonlinear model (i.e. <code><a href="https://rdrr.io/r/stats/nls.html">stats::nls()</a></code>) is an art. Given that each of the formulas represented by the <code>model</code> argument of <code><a href="../reference/fit_gaussian_2D.html">fit_gaussian_2D()</a></code> contains 5 to 7 parameters, <code><a href="https://rdrr.io/r/stats/nls.html">stats::nls()</a></code> will often encounter singular gradients or step size errors.</p>
<p>Code within <code><a href="../reference/fit_gaussian_2D.html">fit_gaussian_2D()</a></code> will first scan the supplied dataset to guesstimate sensible initial parameters, which hopefully sidesteps these issues. But there is no guarantee this strategy will always work.</p>
<p>This vignette will offer some guidance on what to do when <code><a href="https://rdrr.io/r/stats/nls.html">stats::nls()</a></code> fails to converge, including the use of optional parameters in <code><a href="../reference/fit_gaussian_2D.html">fit_gaussian_2D()</a></code> that are meant to help you address these issues.</p>
<p>Let’s start by loading <code>gaussplotR</code> and getting some sample data loaded up:</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/vbaliga/gaussplotR">gaussplotR</a></span><span class="op">)</span>

<span class="co">## Load the sample data set</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">gaussplot_sample_data</span><span class="op">)</span>

<span class="co">## The raw data we'd like to use are in columns 1:3</span>
<span class="va">samp_dat</span> <span class="op">&lt;-</span>
  <span class="va">gaussplot_sample_data</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></pre></div>
<div id="singular-gradients" class="section level2">
<h2 class="hasAnchor">
<a href="#singular-gradients" class="anchor"></a>Singular gradients</h2>
<p>One common problem is that of singular gradients. I will intentionally comment out the next block of code because running it will produce the singular gradient error, and generating errors in an R Markdown file will prevent its rendering. Please un-comment the example below to see.</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="co">## Un-comment this example if you'd like to see a singular gradient error</span>
<span class="co"># gauss_fit_cir &lt;-</span>
<span class="co">#   fit_gaussian_2D(samp_dat,</span>
<span class="co">#                   constrain_amplitude = TRUE,</span>
<span class="co">#                   method = "circular")</span></pre></div>
<p>The output from the above example should be:</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="co">#&gt; Error in stats::nls(response ~ Amp_init * exp(-((((X_values - X_peak)^2)/(2 *  : </span>
<span class="co">#&gt;   singular gradient</span>
<span class="co">#&gt; Called from: stats::nls(response ~ Amp_init * exp(-((((X_values - X_peak)^2)/(2 * </span>
<span class="co">#&gt;     X_sig^2) + ((Y_values - Y_peak)^2)/(2 * Y_sig^2)))), start = c(X_peak = #&gt; _peak_init, &gt;</span>
<span class="co">#&gt;     Y_peak = Y_peak_init, X_sig = X_sig_init, Y_sig = Y_sig_init), </span>
<span class="co">#&gt;     data = data, trace = verbose, control = list(maxiter = maxiter, </span>
<span class="co">#&gt;         ...))</span>
<span class="co">#&gt; Error during wrapup: unimplemented type (29) in 'eval'</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Error: no more error handlers available (recursive errors?); invoking 'abort' restart</span>
<span class="co">#&gt; Error during wrapup: INTEGER() can only be applied to a 'integer', not a 'unknown type #&gt; #29'</span>
<span class="co">#&gt; Error: no more error handlers available (recursive errors?); invoking 'abort' restart</span></pre></div>
<p>There are a couple tools in <code>gaussplotR</code> that can help you address this problem.</p>
<p>A good first step is to enable the optional argument <code>print_initial_params</code> in <code><a href="../reference/fit_gaussian_2D.html">fit_gaussian_2D()</a></code> by setting it to <code>TRUE</code>. Again, please un-comment this next block, since it will still produce an error:</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="co">## Un-comment this example if you'd like to see a singular gradient error</span>
<span class="co"># gauss_fit_cir &lt;-</span>
<span class="co">#   fit_gaussian_2D(samp_dat,</span>
<span class="co">#                   constrain_amplitude = TRUE,</span>
<span class="co">#                   method = "circular",</span>
<span class="co">#                   print_initial_params = TRUE)</span></pre></div>
<p>Though this block of code will not work, you will at least see something helpful at the beginning of the error message:</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="co">#&gt; Initial parameters:</span>
<span class="co">#&gt;       Amp    X_peak    Y_peak     X_sig     Y_sig </span>
<span class="co">#&gt; 25.725293 -2.000000  3.000000  2.482892  2.500000 </span>
<span class="co">#&gt; Error in stats::nls(response ~ Amp_init * exp(-((((X_values - X_peak)^2)/(2 *  : </span>
<span class="co">#&gt;   singular gradient</span>
<span class="co">#&gt; Called from: stats::nls(response ~ Amp_init * exp(-((((X_values - X_peak)^2)/(2 * </span>
<span class="co">#&gt;     X_sig^2) + ((Y_values - Y_peak)^2)/(2 * Y_sig^2)))), start = c(X_peak = #&gt; _peak_init, &gt;</span>
<span class="co">#&gt;     Y_peak = Y_peak_init, X_sig = X_sig_init, Y_sig = Y_sig_init), </span>
<span class="co">#&gt;     data = data, trace = verbose, control = list(maxiter = maxiter, </span>
<span class="co">#&gt;         ...))</span>
<span class="co">#&gt; Error during wrapup: unimplemented type (29) in 'eval'</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Error: no more error handlers available (recursive errors?); invoking 'abort' restart</span>
<span class="co">#&gt; Error during wrapup: INTEGER() can only be applied to a 'integer', not a 'unknown type #&gt; #29'</span>
<span class="co">#&gt; Error: no more error handlers available (recursive errors?); invoking 'abort' restart</span></pre></div>
<p>Those first three lines indicate the initial values that were used. Often, singular gradients will arise when initial values for parameters were poorly chosen (sorry!).</p>
<p>What you can do is supply your own set of initial values. To do this, use the optional argument <code>user_init</code> within <code><a href="../reference/fit_gaussian_2D.html">fit_gaussian_2D()</a></code>. You will need to supply a numeric vector that is of the same length as the number of parameters for your chosen model. The values you supply must be provided in the same order they appear in the Initial parameters message. They do not need to be named; values alone will suffice.</p>
<p>This next example will work. I’ll keep <code>print_initial_params</code> on too, since it can be nice to see:</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="co">## This should run with no errors</span>
<span class="va">gauss_fit_cir_user</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="../reference/fit_gaussian_2D.html">fit_gaussian_2D</a></span><span class="op">(</span><span class="va">samp_dat</span>,
                  constrain_amplitude <span class="op">=</span> <span class="cn">TRUE</span>,
                  method <span class="op">=</span> <span class="st">"circular"</span>,
                  user_init <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">25.72529</span>, <span class="op">-</span><span class="fl">2.5</span>, <span class="fl">1.7</span>, <span class="fl">1.3</span>, <span class="fl">1.6</span><span class="op">)</span>,
                  print_initial_params <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#&gt; Initial parameters:</span>
<span class="co">#&gt;      Amp   X_peak   Y_peak    X_sig    Y_sig </span>
<span class="co">#&gt; 25.72529 -2.50000  1.70000  1.30000  1.60000</span>
<span class="va">gauss_fit_cir_user</span>
<span class="co">#&gt; $coefs</span>
<span class="co">#&gt;        Amp    X_peak   Y_peak    X_sig    Y_sig</span>
<span class="co">#&gt; 1 25.72529 -2.549886 1.858539 1.268501 1.496817</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $model</span>
<span class="co">#&gt; Nonlinear regression model</span>
<span class="co">#&gt;   model: response ~ Amp_init * exp(-((((X_values - X_peak)^2)/(2 * X_sig^2) +     ((Y_values - Y_peak)^2)/(2 * Y_sig^2))))</span>
<span class="co">#&gt;    data: data</span>
<span class="co">#&gt; X_peak Y_peak  X_sig  Y_sig </span>
<span class="co">#&gt; -2.550  1.859  1.269  1.497 </span>
<span class="co">#&gt;  residual sum-of-squares: 906.9</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Number of iterations to convergence: 20 </span>
<span class="co">#&gt; Achieved convergence tolerance: 8.047e-06</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $model_error_stats</span>
<span class="co">#&gt;        rss    rmse deviance      AIC</span>
<span class="co">#&gt; 1 906.8782 5.01907 906.8782 228.3172</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $fit_method</span>
<span class="co">#&gt;        method     amplitude   orientation </span>
<span class="co">#&gt;    "circular" "constrained"            NA </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; attr(,"gaussplotR")</span>
<span class="co">#&gt; [1] "gaussplotR_fit"</span></pre></div>
<p>Note that although we are constraining the amplitude, the value of <code>Amp</code> must still be provided (here it is <code>25.72529</code>).</p>
<p>It may take some trial and error to find a set of <code>user_init</code> values that gets your model to converge. It often makes sense to think about what values are feasible for each parameter. For example, it should be relatively straightforward to think of ranges of possible values for <code>X_peak</code> and <code>Y_peak</code>. I often find that finding good initial values for the “spread” parameters (such as <code>X_sig</code> and <code>Y_sig</code>) is the tough nut to crack, so I recommend tweaking those parameters first.</p>
</div>
<div id="additional-control-arguments-to-nls" class="section level2">
<h2 class="hasAnchor">
<a href="#additional-control-arguments-to-nls" class="anchor"></a>Additional control arguments to <code>nls()</code>
</h2>
<p>The <code><a href="../reference/fit_gaussian_2D.html">fit_gaussian_2D()</a></code> function also allows you to pass additional control arguments to <code><a href="https://rdrr.io/r/stats/nls.control.html">stats::nls.control()</a></code> via the <code>...</code> argument.</p>
<p>To put this in more technical terms, arguments supplied to <code>...</code> are handled as:<br><code><a href="https://rdrr.io/r/stats/nls.html">stats::nls(control = list(maxiter, ...))</a></code></p>
<p>Therefore, if you are interested in changing e.g. <code>minFactor</code> to <code>1/2048</code>:<br><code><a href="../reference/fit_gaussian_2D.html">fit_gaussian_2D(data, model, minFactor = 1/2048)</a></code></p>
<p>See the Help file for <code><a href="https://rdrr.io/r/stats/nls.control.html">stats::nls.control()</a></code> for further guidance on what these control arguments are.</p>
<p>Please also note that that tweaking <code>maxiter</code> should not be handled via <code>...</code> but rather by the <code>maxiter</code> argument to <code><a href="../reference/fit_gaussian_2D.html">fit_gaussian_2D()</a></code>.</p>
</div>
<div id="use-parameter-constraints-with-caution" class="section level2">
<h2 class="hasAnchor">
<a href="#use-parameter-constraints-with-caution" class="anchor"></a>Use parameter constraints with caution</h2>
<p>Our scapegoat here is setting <code>constrain_amplitude = TRUE</code>. Often, when constraining parameters in a nonlinear model, you’ll find yourself in a scenario where the QR decomposition of the gradient matrix is not of full column rank.</p>
<p>Constraining parameters (amplitude or orientation) will lead to poorer-fitting Gaussians anyway, so these features should only be used if you have an <em>a priori</em> reason to do so (see examples in Priebe et al. 2003<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>)</p>
<p>Turning off the <code>constrain_amplitude</code> constraint alleviates the problem in this particular case:</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="co">## This should run with no errors</span>
<span class="va">gauss_fit_cir</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="../reference/fit_gaussian_2D.html">fit_gaussian_2D</a></span><span class="op">(</span><span class="va">samp_dat</span>,
                  method <span class="op">=</span> <span class="st">"circular"</span><span class="op">)</span>
<span class="va">gauss_fit_cir</span>
<span class="co">#&gt; $coefs</span>
<span class="co">#&gt;        Amp    X_peak   Y_peak    X_sig    Y_sig</span>
<span class="co">#&gt; 1 23.18005 -2.546643 1.811152 1.316288 1.642641</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $model</span>
<span class="co">#&gt; Nonlinear regression model</span>
<span class="co">#&gt;   model: response ~ Amp * exp(-((((X_values - X_peak)^2)/(2 * X_sig^2) +     ((Y_values - Y_peak)^2)/(2 * Y_sig^2))))</span>
<span class="co">#&gt;    data: data</span>
<span class="co">#&gt;    Amp X_peak Y_peak  X_sig  Y_sig </span>
<span class="co">#&gt; 23.180 -2.547  1.811  1.316  1.643 </span>
<span class="co">#&gt;  residual sum-of-squares: 899.6</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Number of iterations to convergence: 22 </span>
<span class="co">#&gt; Achieved convergence tolerance: 9.054e-06</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $model_error_stats</span>
<span class="co">#&gt;       rss     rmse deviance      AIC</span>
<span class="co">#&gt; 1 899.613 4.998925  899.613 230.0276</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $fit_method</span>
<span class="co">#&gt;          method       amplitude     orientation </span>
<span class="co">#&gt;      "circular" "unconstrained"              NA </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; attr(,"gaussplotR")</span>
<span class="co">#&gt; [1] "gaussplotR_fit"</span></pre></div>
<p>Hope this helps!</p>
<p>🐢</p>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>Priebe NJ, Cassanello CR, Lisberger SG. The neural representation of speed in macaque area MT/V5. J Neurosci. 2003 Jul 2;23(13):5650-61. doi: 10.1523/JNEUROSCI.23-13-05650.2003.<a href="#fnref1" class="footnote-back">↩</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://www.vikram-baliga.com/">Vikram B. Baliga</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
